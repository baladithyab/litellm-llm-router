# LiteLLM + LLMRouter - High Availability Production Setup
# Includes: PostgreSQL, Redis, multiple gateway instances
#
# SECURITY: Before running, set required secrets in your environment:
#   export LITELLM_MASTER_KEY=$(openssl rand -hex 32)
#   export POSTGRES_PASSWORD=$(openssl rand -hex 16)

services:
  # ==========================================================================
  # PostgreSQL - Persistent storage for LiteLLM
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: litellm-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-litellm}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-litellm_password}
      POSTGRES_DB: ${POSTGRES_DB:-litellm}
    ports:
      - "5432:5432"  # Exposed for HA integration tests (leader election queries)
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-litellm}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - litellm-network

  # ==========================================================================
  # Redis - Caching and distributed state
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: litellm-redis
    command: >
      redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD:-changeme}
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-changeme}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - litellm-network

  # ==========================================================================
  # LiteLLM + LLMRouter Gateway (Primary)
  # ==========================================================================
  litellm-gateway-1:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: ghcr.io/baladithyab/litellm-llm-router:latest
    container_name: litellm-gateway-1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "4000:4000"
    volumes:
      - ./config:/app/config:ro
      - ./models:/app/models:ro
      - ./custom_routers:/app/custom_routers:ro
    environment:
      - LITELLM_CONFIG_PATH=/app/config/config.yaml
      # SECURITY: LITELLM_MASTER_KEY is REQUIRED - no default provided
      # Generate with: openssl rand -hex 32
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY:?LITELLM_MASTER_KEY environment variable is required}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-litellm}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD environment variable is required}@postgres:5432/${POSTGRES_DB:-litellm}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-changeme}
      # LLM Provider API Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - AZURE_API_KEY=${AZURE_API_KEY:-}
      # LLMRouter Settings
      - LLMROUTER_MODELS_PATH=/app/models
      - LLMROUTER_HOT_RELOAD=true
      - LLMROUTER_RELOAD_INTERVAL=300
      # HA Mode - Leader Election
      - LLMROUTER_HA_MODE=${LLMROUTER_HA_MODE:-leader_election}
      - LLMROUTER_CONFIG_SYNC_LEASE_SECONDS=${LLMROUTER_CONFIG_SYNC_LEASE_SECONDS:-30}
      - LLMROUTER_CONFIG_SYNC_RENEW_INTERVAL_SECONDS=${LLMROUTER_CONFIG_SYNC_RENEW_INTERVAL_SECONDS:-10}
      # Gateway Features (A2A, MCP)
      - A2A_GATEWAY_ENABLED=${A2A_GATEWAY_ENABLED:-false}
      - MCP_GATEWAY_ENABLED=${MCP_GATEWAY_ENABLED:-false}
      - STORE_MODEL_IN_DB=${STORE_MODEL_IN_DB:-true}
      # Config Sync & Hot Reload
      - CONFIG_HOT_RELOAD=${CONFIG_HOT_RELOAD:-true}
      - CONFIG_SYNC_ENABLED=${CONFIG_SYNC_ENABLED:-true}
      - CONFIG_SYNC_INTERVAL=${CONFIG_SYNC_INTERVAL:-60}
      # S3/GCS Config Sync (optional)
      - CONFIG_S3_BUCKET=${CONFIG_S3_BUCKET:-}
      - CONFIG_S3_KEY=${CONFIG_S3_KEY:-}
      - LLMROUTER_MODEL_S3_BUCKET=${LLMROUTER_MODEL_S3_BUCKET:-}
      - LLMROUTER_MODEL_S3_KEY=${LLMROUTER_MODEL_S3_KEY:-}
      # AWS Credentials (if using S3)
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/_health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "1.0"
    restart: unless-stopped
    networks:
      - litellm-network

  # ==========================================================================
  # LiteLLM + LLMRouter Gateway (Replica for HA)
  # ==========================================================================
  litellm-gateway-2:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: ghcr.io/baladithyab/litellm-llm-router:latest
    container_name: litellm-gateway-2
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "4001:4000"
    volumes:
      - ./config:/app/config:ro
      - ./models:/app/models:ro
      - ./custom_routers:/app/custom_routers:ro
    environment:
      - LITELLM_CONFIG_PATH=/app/config/config.yaml
      # SECURITY: LITELLM_MASTER_KEY is REQUIRED - no default provided
      # Generate with: openssl rand -hex 32
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY:?LITELLM_MASTER_KEY environment variable is required}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-litellm}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD environment variable is required}@postgres:5432/${POSTGRES_DB:-litellm}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-changeme}
      # LLM Provider API Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - AZURE_API_KEY=${AZURE_API_KEY:-}
      # LLMRouter Settings
      - LLMROUTER_MODELS_PATH=/app/models
      - LLMROUTER_HOT_RELOAD=true
      - LLMROUTER_RELOAD_INTERVAL=300
      # HA Mode - Leader Election
      - LLMROUTER_HA_MODE=${LLMROUTER_HA_MODE:-leader_election}
      - LLMROUTER_CONFIG_SYNC_LEASE_SECONDS=${LLMROUTER_CONFIG_SYNC_LEASE_SECONDS:-30}
      - LLMROUTER_CONFIG_SYNC_RENEW_INTERVAL_SECONDS=${LLMROUTER_CONFIG_SYNC_RENEW_INTERVAL_SECONDS:-10}
      # Gateway Features (A2A, MCP) - same as gateway-1 for HA consistency
      - A2A_GATEWAY_ENABLED=${A2A_GATEWAY_ENABLED:-false}
      - MCP_GATEWAY_ENABLED=${MCP_GATEWAY_ENABLED:-false}
      - STORE_MODEL_IN_DB=${STORE_MODEL_IN_DB:-true}
      # Config Sync & Hot Reload
      - CONFIG_HOT_RELOAD=${CONFIG_HOT_RELOAD:-true}
      - CONFIG_SYNC_ENABLED=${CONFIG_SYNC_ENABLED:-true}
      - CONFIG_SYNC_INTERVAL=${CONFIG_SYNC_INTERVAL:-60}
      # S3/GCS Config Sync (optional)
      - CONFIG_S3_BUCKET=${CONFIG_S3_BUCKET:-}
      - CONFIG_S3_KEY=${CONFIG_S3_KEY:-}
      - LLMROUTER_MODEL_S3_BUCKET=${LLMROUTER_MODEL_S3_BUCKET:-}
      - LLMROUTER_MODEL_S3_KEY=${LLMROUTER_MODEL_S3_KEY:-}
      # AWS Credentials (if using S3)
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/_health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "1.0"
    restart: unless-stopped
    networks:
      - litellm-network

  # ==========================================================================
  # Nginx Load Balancer (SSE-aware)
  # ==========================================================================
  nginx:
    image: nginx:alpine
    container_name: litellm-nginx
    depends_on:
      - litellm-gateway-1
      - litellm-gateway-2
    ports:
      - "8080:80"
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
    environment:
      # SSE proxy settings (disable buffering for streaming)
      - NGINX_ENVSUBST_OUTPUT_DIR=/etc/nginx
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - litellm-network

volumes:
  postgres_data:
  redis_data:

networks:
  litellm-network:
    driver: bridge
