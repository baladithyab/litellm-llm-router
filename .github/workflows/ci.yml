name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Default: no permissions. Each job explicitly requests only what it needs.
permissions: {}

# Removed IMAGE_NAME and TEST_PORT env vars - Docker builds moved to docker-build.yml

jobs:
  # Detect what changed to optimize CI
  changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for checkout
      pull-requests: read  # Required for dorny/paths-filter to list PR files
    outputs:
      python: ${{ steps.filter.outputs.python }}
      compose: ${{ steps.filter.outputs.compose }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36  # v3
        id: filter
        with:
          filters: |
            python:
              - 'src/**'
              - 'tests/**'
              - 'requirements.txt'
              - 'pyproject.toml'
              - 'uv.lock'
            compose:
              - 'docker-compose*.yml'
              - 'examples/mlops/docker-compose*.yml'

  # ===========================================================================
  # Lockfile integrity check - ensures reproducible builds
  # ===========================================================================
  lockfile-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for checkout
    needs: changes
    if: ${{ needs.changes.outputs.python == 'true' || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Install uv
        uses: astral-sh/setup-uv@f06b870e0a91d23284a3013acc55e6f88ab4b904  # v7
        with:
          version: "0.9.26"
          enable-cache: true

      - name: Verify lockfile is up to date
        run: |
          echo "Checking if uv.lock is in sync with pyproject.toml..."
          uv lock --check
          echo "✅ Lockfile is up to date"

  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for checkout
    needs: changes
    if: ${{ needs.changes.outputs.python == 'true' || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Install uv
        uses: astral-sh/setup-uv@f06b870e0a91d23284a3013acc55e6f88ab4b904  # v7
        with:
          version: "0.9.26"
          enable-cache: true

      - name: Run ruff check
        run: uv run --with ruff ruff check src/

      - name: Check formatting with ruff
        run: uv run --with ruff ruff format --check src/

  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for checkout
    needs: [changes, lockfile-check]
    if: ${{ needs.changes.outputs.python == 'true' || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Install uv
        uses: astral-sh/setup-uv@f06b870e0a91d23284a3013acc55e6f88ab4b904  # v7
        with:
          version: "0.9.26"
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.14

      - name: Install dependencies from lockfile
        run: |
          # Use frozen install for reproducibility
          uv sync --frozen --extra dev
          # Install LLMRouter at pinned commit (matches docker/Dockerfile)
          uv pip install --python .venv/bin/python git+https://github.com/ulab-uiuc/LLMRouter.git@7890cd9d36951a3c73fec83619321f3704a7aaa8

      - name: Run unit tests
        run: |
          .venv/bin/python -m pytest tests/test_strategies.py -v --tb=short
        env:
          PYTHONPATH: src

  # ===========================================================================
  # Dependency vulnerability scan - SBOM/supply chain security
  # ===========================================================================
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for checkout
    needs: [changes, lockfile-check]
    if: ${{ needs.changes.outputs.python == 'true' || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Install uv
        uses: astral-sh/setup-uv@f06b870e0a91d23284a3013acc55e6f88ab4b904  # v7
        with:
          version: "0.9.26"
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.14

      - name: Install dependencies
        run: uv sync --frozen --extra dev

      - name: Run pip-audit on lockfile
        run: |
          echo "=== Scanning dependencies for known vulnerabilities ==="
          uv run --with pip-audit pip-audit --require-hashes --disable-pip -r <(uv export --frozen --no-dev) || {
            echo "⚠️ Vulnerabilities found - review output above"
            # Non-blocking for now; set exit 1 to block on vulnerabilities
            exit 0
          }
          echo "✅ No known vulnerabilities found"

  validate-compose:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for checkout
    needs: changes
    if: ${{ needs.changes.outputs.compose == 'true' || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Validate docker-compose.yml
        run: docker compose -f docker-compose.yml config
        env:
          # Dummy value for CI validation only - never used in production
          LITELLM_MASTER_KEY: ci_validation_dummy_key

      - name: Validate docker-compose.ha.yml
        run: docker compose -f docker-compose.ha.yml config
        env:
          # Dummy values for CI validation only - never used in production
          LITELLM_MASTER_KEY: ci_validation_dummy_key
          POSTGRES_PASSWORD: ci_validation_dummy_password

      - name: Validate MLOps compose
        run: docker compose -f examples/mlops/docker-compose.mlops.yml config
