name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Default: no permissions. Each job explicitly requests only what it needs.
permissions: {}

# Removed IMAGE_NAME and TEST_PORT env vars - Docker builds moved to docker-build.yml

jobs:
  # Detect what changed to optimize CI
  changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for checkout
      pull-requests: read  # Required for dorny/paths-filter to list PR files
    outputs:
      python: ${{ steps.filter.outputs.python }}
      compose: ${{ steps.filter.outputs.compose }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v4
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36  # v3
        id: filter
        with:
          filters: |
            python:
              - 'src/**'
              - 'tests/**'
              - 'requirements.txt'
              - 'pyproject.toml'
            compose:
              - 'docker-compose*.yml'
              - 'examples/mlops/docker-compose*.yml'

  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for checkout
    needs: changes
    if: ${{ needs.changes.outputs.python == 'true' || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v4

      - name: Install uv
        uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b  # v7
        with:
          version: "0.9.26"
          enable-cache: true

      - name: Run ruff check
        run: uv run --with ruff ruff check src/

      - name: Check formatting with ruff
        run: uv run --with ruff ruff format --check src/

  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for checkout
    needs: changes
    if: ${{ needs.changes.outputs.python == 'true' || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v4

      - name: Install uv
        uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b  # v7
        with:
          version: "0.9.26"
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.11

      - name: Create virtual environment and install dependencies
        run: |
          uv venv .venv
          uv pip install --python .venv/bin/python git+https://github.com/ulab-uiuc/LLMRouter.git
          uv pip install --python .venv/bin/python litellm pytest pytest-asyncio
          uv pip install --python .venv/bin/python -r requirements.txt

      - name: Run unit tests
        run: |
          .venv/bin/python -m pytest tests/test_strategies.py -v --tb=short
        env:
          PYTHONPATH: src

  # Docker build, smoke tests, and security scans are handled in docker-build.yml

  validate-compose:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for checkout
    needs: changes
    if: ${{ needs.changes.outputs.compose == 'true' || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v4

      - name: Validate docker-compose.yml
        run: docker compose -f docker-compose.yml config

      - name: Validate docker-compose.ha.yml
        run: docker compose -f docker-compose.ha.yml config

      - name: Validate MLOps compose
        run: docker compose -f examples/mlops/docker-compose.mlops.yml config
