# =============================================================================
# Quota Enforcement Test - Docker Compose
# =============================================================================
# Minimal compose file for TG3.1 quota enforcement integration testing.
#
# Usage:
#   finch compose -f docker-compose.quota-test.yml up -d --build
#   uv run pytest tests/integration/test_quota_enforcement.py -v
#   finch compose -f docker-compose.quota-test.yml down -v
#
# This setup includes:
#   - redis: Quota storage backend
#   - gateway: LiteLLM + LLMRouter proxy with quota enforcement enabled
#
# Quota limits configured:
#   - 5 requests per minute
#   - 1000 tokens per minute
#   - $0.10 USD per hour
# =============================================================================

services:
  # ==========================================================================
  # Redis - Quota storage backend
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: quota-test-redis
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 2s
      retries: 10
    networks:
      - quota-test-network

  # ==========================================================================
  # LiteLLM + LLMRouter Gateway with Quota Enforcement
  # ==========================================================================
  gateway:
    build:
      context: .
      dockerfile: docker/Dockerfile.local
    container_name: quota-test-gateway
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "4030:4000"
    volumes:
      - ./config:/app/config:ro
      - ./scripts:/app/scripts:ro
    environment:
      # Core settings
      - LITELLM_MASTER_KEY=quota-test-master-key
      - ADMIN_API_KEY=quota-test-admin-key
      - ADMIN_API_KEYS=quota-test-admin-key,quota-test-master-key
      # Redis for quota storage
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Quota enforcement
      - ROUTEIQ_QUOTA_ENABLED=true
      - ROUTEIQ_QUOTA_FAIL_MODE=closed
      # JSON must be properly quoted in YAML - use double quotes around the value
      - 'ROUTEIQ_QUOTA_LIMITS_JSON=[{"metric": "requests", "window": "minute", "limit": 5}, {"metric": "total_tokens", "window": "minute", "limit": 1000}, {"metric": "spend_usd", "window": "hour", "limit": 0.1}]'
      # Gateway features (minimal for quota test)
      - MCP_GATEWAY_ENABLED=false
      - A2A_GATEWAY_ENABLED=false
      - STORE_MODEL_IN_DB=false
      # Stub model for deterministic testing
      - LITELLM_CONFIG_PATH=/app/config/config.quota-test.yaml
    command: ["--config", "/app/config/config.quota-test.yaml", "--port", "4000"]
    healthcheck:
      test: ["CMD", "curl", "-f", "-H", "Authorization: Bearer quota-test-master-key", "http://localhost:4000/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - quota-test-network

networks:
  quota-test-network:
    driver: bridge
