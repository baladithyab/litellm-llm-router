# syntax=docker/dockerfile:1.4
# =============================================================================
# LiteLLM + LLMRouter Local Development Dockerfile
# =============================================================================
# Clones LLMRouter from GitHub with pinned version for reproducibility
# Uses uv for fast, lockfile-driven package management
#
# Reproducible Builds:
#   This Dockerfile uses uv.lock for deterministic dependency resolution.
#   Run `uv lock --check` locally to verify lockfile is up-to-date before building.
#
# Usage:
#   docker build -f docker/Dockerfile.local -t litellm-llmrouter:local .
#   docker compose -f docker-compose.local-test.yml up
# =============================================================================

ARG PYTHON_VERSION=3.14
ARG UV_VERSION=0.9
ARG LITELLM_VERSION=1.81.3
# LLMRouter pinned to specific commit for reproducibility
ARG LLMROUTER_COMMIT=7890cd9d36951a3c73fec83619321f3704a7aaa8

# ==============================================================================
# Base image digest for reproducibility
# To update: docker pull <image> && docker inspect --format='{{index .RepoDigests 0}}' <image>
# ==============================================================================
ARG BASE_DIGEST=sha256:f37be263fb880ce4ed918e487d84576462fb4fafa934dbd08d216ab4cf058808

FROM ghcr.io/astral-sh/uv:${UV_VERSION}-python${PYTHON_VERSION}-bookworm-slim@${BASE_DIGEST}

ARG LITELLM_VERSION
ARG LLMROUTER_COMMIT

LABEL org.opencontainers.image.description="LiteLLM + LLMRouter: Local Development Build"
LABEL org.opencontainers.image.version="${LITELLM_VERSION}-dev"
LABEL llmrouter.commit="${LLMROUTER_COMMIT}"
LABEL build.reproducible="true"
LABEL build.lockfile-driven="uv.lock"

WORKDIR /app

# Install system dependencies (including dev tools and libatomic for Prisma/Node)
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    ca-certificates \
    tini \
    libatomic1 \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /var/cache/apt/*

# =============================================================================
# Lockfile-driven dependency installation for reproducibility
# =============================================================================
# Copy lockfile and project metadata first for layer caching
COPY pyproject.toml uv.lock /app/
COPY src/ /app/src/

# Install dependencies using uv sync --frozen
# --frozen: Fail if lockfile is out of sync with pyproject.toml (ensures reproducibility)
# All OTEL packages are included via the 'otel' extra in the lockfile
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --no-dev --extra db --extra otel

# Note: Prisma client is generated at runtime in entrypoint.sh
# This allows the container to work with different database configurations

# Clone and install LLMRouter from GitHub at pinned commit
RUN git clone --depth 1 https://github.com/ulab-uiuc/LLMRouter.git /tmp/LLMRouter && \
    cd /tmp/LLMRouter && \
    git fetch --depth 1 origin ${LLMROUTER_COMMIT} && \
    git checkout ${LLMROUTER_COMMIT} && \
    uv pip install --system . && \
    rm -rf /tmp/LLMRouter

# Copy custom routing integration
COPY src/litellm_llmrouter /app/litellm_llmrouter

# Copy entrypoint and config
COPY docker/entrypoint.local.sh /app/entrypoint.sh
COPY config/ /app/config/

# Create directories
RUN mkdir -p /app/models /app/data /app/custom_routers && \
    chmod +x /app/entrypoint.sh

# Environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONFAULTHANDLER=1 \
    PYTHONPATH=/app \
    LITELLM_CONFIG_PATH=/app/config/config.yaml \
    LLMROUTER_MODELS_PATH=/app/models

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:4000/health/liveliness || exit 1

EXPOSE 4000

# Use tini for proper signal handling
ENTRYPOINT ["/usr/bin/tini", "--", "/app/entrypoint.sh"]
CMD ["--config", "/app/config/config.yaml", "--port", "4000"]
